<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero - Acceso Restringido</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #558b2f;
            --accent: #7cb342;
            --light: #f1f8e9;
            --dark: #1b5e20;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
        }
        
        .dashboard-container {
            display: none;
            width: 100%;
        }
        
        .logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .login-title {
            color: var(--dark);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #6c757d;
            margin-bottom: 30px;
        }
        
        .g_id_signin {
            width: 100%;
            margin: 20px 0;
        }
        
        .user-info {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            color: white;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 0 auto 15px;
        }
        
        .access-denied {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        /* Estilos del dashboard (los mismos de antes) */
        .dashboard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            padding: 24px;
            transition: all 0.3s ease;
            border-left: 6px solid var(--primary);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
        }
        
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Contenedor de Login -->
    <div id="login-container" class="login-container">
        <div class="logo">
            <i class="fas fa-seedling"></i>
        </div>
        <h2 class="login-title">Dashboard Agroecol贸gico</h2>
        <p class="login-subtitle">Acceso restringido al propietario</p>
        
        <div id="google-login-button" class="g_id_signin"
            data-type="standard"
            data-theme="filled_blue"
            data-text="signin_with"
            data-shape="pill"
            data-logo_alignment="left"
            data-width="300">
        </div>
        
        <div id="user-info" class="user-info" style="display: none;">
            <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
            <h5 id="user-name" class="mb-2"></h5>
            <p id="user-email" class="mb-0"></p>
        </div>
        
        <div id="access-denied" class="access-denied" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>Acceso Denegado</h5>
            <p class="mb-0">Solo el propietario del archivo puede acceder a este dashboard.</p>
        </div>
        
        <div class="mt-4">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Tus datos est谩n protegidos y no se comparten con terceros
            </small>
        </div>
    </div>

    <!-- Contenedor del Dashboard (oculto inicialmente) -->
    <div id="dashboard-container" class="dashboard-container container-fluid">
        <!-- Header -->
        <div class="navbar-custom text-white p-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-2"><i class="fas fa-seedling me-2"></i>Dashboard Agroecol贸gico</h3>
                    <p class="mb-0 opacity-75">Acceso autorizado - <span id="authorized-user"></span></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="kpi-badge me-2">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span id="update-text">Actualizando...</span>
                    </span>
                    <button class="btn btn-light btn-sm me-2" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesi贸n
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-semibold"> Periodo</label>
                    <select id="month-filter" class="form-select">
                        <option value="all">Todos los meses</option>
                        <option value="7">Julio 2025</option>
                        <option value="8">Agosto 2025</option>
                        <option value="9">Septiembre 2025</option>
                        <option value="10">Octubre 2025</option>
                        <option value="11">Noviembre 2025</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold"> Proyecto</label>
                    <select id="project-filter" class="form-select">
                        <option value="all">Todos los proyectos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold"> Tipo</label>
                    <select id="type-filter" class="form-select">
                        <option value="all">Todos los tipos</option>
                        <option value="Ingreso">Ingresos</option>
                        <option value="Egreso">Egresos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="updateDashboard()">
                        <i class="fas fa-filter me-2"></i>Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-balance-scale"></i> Balance Total</div>
                    <div class="stat-number" id="total-balance">$0</div>
                    <div class="stat-label">Acumulado General</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-arrow-up"></i> Ingresos Totales</div>
                    <div class="stat-number" id="total-income">$0</div>
                    <div class="stat-label">Periodo actual</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-arrow-down"></i> Egresos Totales</div>
                    <div class="stat-number" id="total-expenses">$0</div>
                    <div class="stat-label">Periodo actual</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Ventas Totales</div>
                    <div class="stat-number" id="total-sales">$0</div>
                    <div class="stat-label">Registro diario</div>
                </div>
            </div>
        </div>

        <!-- Gr谩ficos -->
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> Balance Mensual</div>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-chart-pie"></i> Ingresos vs Egresos</div>
                    <div class="chart-container">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-tags"></i> Ventas por Categor铆a</div>
                    <div class="chart-container">
                        <canvas id="salesCategoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-project-diagram"></i> Transacciones por Proyecto</div>
                    <div class="chart-container">
                        <canvas id="projectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de transacciones -->
        <div class="dashboard-card mt-4">
            <div class="card-title d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list-alt"></i> Transacciones Recientes</span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="transactions-table">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Categor铆a</th>
                            <th>Monto</th>
                            <th>Proyecto</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Datos cargados din谩micamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="loading" id="loading-indicator">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
            <p class="mt-3">Cargando datos financieros en tiempo real...</p>
        </div>
    </div>

    <script>
        // CONFIGURACIN - REEMPLAZA CON TUS DATOS
        const CONFIG = {
            SHEET_ID: '15OBpWVzSX-jXXX99k1T9iZZtIoIj-appiH45w3BSBDY',
            // Agrega aqu铆 el email del propietario autorizado
            AUTHORIZED_OWNER: 'tu_email@gmail.com', // REEMPLAZA CON TU EMAIL
            // Opcional: Configuraci贸n de Google OAuth (Client ID)
            // CLIENT_ID: 'tu_client_id.apps.googleusercontent.com'
        };

        // URLs de las hojas
        const FINANZAS_MENSUAL_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Finanzas_Mensual`;
        const FINANZAS_REGISTRO_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Finanzas_RegistroDiario`;
        const VENTAS_REGISTRO_URL = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Ventas_RegistroDiario`;

        // Variables globales
        let financialData = {
            monthly: [],
            daily: [],
            sales: []
        };

        let charts = {};
        let currentUser = null;

        // Inicializaci贸n
        document.addEventListener('DOMContentLoaded', function() {
            initializeGoogleAuth();
            checkExistingSession();
        });

        // Inicializar autenticaci贸n de Google
        function initializeGoogleAuth() {
            window.google.accounts.id.initialize({
                // client_id: CONFIG.CLIENT_ID, // Descomenta si usas Client ID espec铆fico
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: false
            });

            window.google.accounts.id.renderButton(
                document.getElementById('google-login-button'),
                { theme: "filled_blue", size: "large", width: 300 }
            );
        }

        // Manejar respuesta de autenticaci贸n
        function handleCredentialResponse(response) {
            const responsePayload = parseJwt(response.credential);
            
            currentUser = {
                name: responsePayload.name,
                email: responsePayload.email,
                picture: responsePayload.picture
            };

            showUserInfo(currentUser);
            verifyAccess();
        }

        // Verificar acceso del usuario
        function verifyAccess() {
            if (currentUser.email === CONFIG.AUTHORIZED_OWNER) {
                grantAccess();
            } else {
                denyAccess();
            }
        }

        // Otorgar acceso
        function grantAccess() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            document.getElementById('authorized-user').textContent = currentUser.email;
            
            // Inicializar dashboard
            initializeDashboard();
        }

        // Denegar acceso
        function denyAccess() {
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            document.getElementById('google-login-button').style.display = 'none';
            
            // Limpiar sesi贸n
            currentUser = null;
            localStorage.removeItem('google_auth');
        }

        // Mostrar informaci贸n del usuario
        function showUserInfo(user) {
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').src = user.picture;
            document.getElementById('user-info').style.display = 'block';
        }

        // Verificar sesi贸n existente
        function checkExistingSession() {
            const savedAuth = localStorage.getItem('google_auth');
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    if (authData.expires > Date.now()) {
                        currentUser = authData.user;
                        showUserInfo(currentUser);
                        verifyAccess();
                    } else {
                        localStorage.removeItem('google_auth');
                    }
                } catch (e) {
                    localStorage.removeItem('google_auth');
                }
            }
        }

        // Cerrar sesi贸n
        function logout() {
            currentUser = null;
            localStorage.removeItem('google_auth');
            
            // Google Sign-Out
            google.accounts.id.disableAutoSelect();
            
            // Mostrar login
            document.getElementById('dashboard-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('access-denied').style.display = 'none';
            document.getElementById('google-login-button').style.display = 'block';
        }

        // Guardar sesi贸n
        function saveSession() {
            if (currentUser) {
                const authData = {
                    user: currentUser,
                    expires: Date.now() + (24 * 60 * 60 * 1000) // 24 horas
                };
                localStorage.setItem('google_auth', JSON.stringify(authData));
            }
        }

        // Parse JWT token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error('Error parsing JWT:', e);
                return {};
            }
        }

        // ============================================
        // FUNCIONALIDAD DEL DASHBOARD (igual que antes)
        // ============================================

        async function initializeDashboard() {
            showLoading(true);
            await loadAllData();
            setupEventListeners();
            showLoading(false);
            saveSession();
        }

        function setupEventListeners() {
            document.getElementById('month-filter').addEventListener('change', updateDashboard);
            document.getElementById('project-filter').addEventListener('change', updateDashboard);
            document.getElementById('type-filter').addEventListener('change', updateDashboard);
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadFinancialMonthlyData(),
                    loadFinancialDailyData(),
                    loadSalesData()
                ]);
                document.getElementById('update-text').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error cargando datos:', error);
                showNotification('Error al cargar los datos', 'error');
            }
        }

        function parseArgentineNumber(str) {
            if (!str || str === '') return 0;
            let cleaned = str.toString().replace(/[^\d,-]/g, '');
            if (cleaned.includes(',') && !cleaned.includes('.')) {
                cleaned = cleaned.replace(',', '.');
            } else if (cleaned.includes(',') && cleaned.includes('.')) {
                cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            }
            const result = parseFloat(cleaned);
            return isNaN(result) ? 0 : result;
        }

        function extractMonthFromDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.getMonth() + 1;
            } catch (e) {
                return 0;
            }
        }

        async function loadFinancialMonthlyData() {
            return new Promise((resolve, reject) => {
                Papa.parse(FINANZAS_MENSUAL_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: function(results) {
                        financialData.monthly = results.data
                            .filter(row => row.Mes && !isNaN(parseArgentineNumber(row.Mes)))
                            .map(row => ({
                                ...row,
                                Mes: parseArgentineNumber(row.Mes),
                                'Total Ingresos': parseArgentineNumber(row['Total Ingresos']),
                                'Total Egresos': parseArgentineNumber(row['Total Egresos']),
                                Balance: parseArgentineNumber(row.Balance)
                            }));
                        resolve();
                    }, error: reject
                });
            });
        }

        async function loadFinancialDailyData() {
            return new Promise((resolve, reject) => {
                Papa.parse(FINANZAS_REGISTRO_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: function(results) {
                        financialData.daily = results.data
                            .filter(row => row.Fecha && row.Monto)
                            .map(row => ({
                                ...row,
                                Monto: parseArgentineNumber(row.Monto),
                                Mes: parseArgentineNumber(row.Mes)
                            }));
                        resolve();
                    }, error: reject
                });
            });
        }

        async function loadSalesData() {
            return new Promise((resolve, reject) => {
                Papa.parse(VENTAS_REGISTRO_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: function(results) {
                        financialData.sales = results.data
                            .filter(row => row.Fecha && row.Total)
                            .map(row => ({
                                ...row,
                                Total: parseArgentineNumber(row.Total),
                                'Precio Unitario': parseArgentineNumber(row['Precio Unitario']),
                                Cantidad: parseArgentineNumber(row.Cantidad),
                                Mes: extractMonthFromDate(row.Fecha)
                            }));
                        resolve();
                    }, error: reject
                });
            });
        }

        function updateDashboard() {
            updateQuickStats();
            updateCharts();
            updateTransactionsTable();
            updateProjectFilter();
        }

        function updateQuickStats() {
            const monthFilter = document.getElementById('month-filter').value;
            
            let totalBalance = 0;
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalSales = 0;

            financialData.monthly.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    totalBalance += row.Balance || 0;
                    totalIncome += row['Total Ingresos'] || 0;
                    totalExpenses += row['Total Egresos'] || 0;
                }
            });

            financialData.sales.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    totalSales += row.Total || 0;
                }
            });

            document.getElementById('total-balance').textContent = formatCurrency(totalBalance);
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('total-sales').textContent = formatCurrency(totalSales);
        }

        function updateCharts() {
            updateBalanceChart();
            updateIncomeExpenseChart();
            updateSalesCategoryChart();
            updateProjectChart();
        }

        function updateBalanceChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            const months = financialData.monthly.map(row => `Mes ${row.Mes}`);
            const balances = financialData.monthly.map(row => row.Balance || 0);

            if (charts.balanceChart) charts.balanceChart.destroy();

            charts.balanceChart = new Chart(ctx, {
                type: 'line', data: { labels: months, datasets: [{
                    label: 'Balance', data: balances, borderColor: '#2e7d32',
                    backgroundColor: 'rgba(46, 125, 50, 0.1)', borderWidth: 2, fill: true, tension: 0.4
                }]}, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateIncomeExpenseChart() {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            const months = financialData.monthly.map(row => `Mes ${row.Mes}`);
            const incomes = financialData.monthly.map(row => row['Total Ingresos'] || 0);
            const expenses = financialData.monthly.map(row => row['Total Egresos'] || 0);

            if (charts.incomeExpenseChart) charts.incomeExpenseChart.destroy();

            charts.incomeExpenseChart = new Chart(ctx, {
                type: 'bar', data: { labels: months, datasets: [
                    { label: 'Ingresos', data: incomes, backgroundColor: '#28a745' },
                    { label: 'Egresos', data: expenses, backgroundColor: '#dc3545' }
                ]}, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateSalesCategoryChart() {
            const ctx = document.getElementById('salesCategoryChart').getContext('2d');
            const monthFilter = document.getElementById('month-filter').value;
            
            const categories = {};
            financialData.sales.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    const category = row.Categor铆a || 'Sin categor铆a';
                    const total = row.Total || 0;
                    categories[category] = (categories[category] || 0) + total;
                }
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);

            if (charts.salesCategoryChart) charts.salesCategoryChart.destroy();

            charts.salesCategoryChart = new Chart(ctx, {
                type: 'doughnut', data: { labels, datasets: [{
                    data, backgroundColor: ['#2e7d32', '#558b2f', '#7cb342', '#aed581', '#c5e1a5']
                }]}, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateProjectChart() {
            const ctx = document.getElementById('projectChart').getContext('2d');
            const monthFilter = document.getElementById('month-filter').value;
            
            const projects = {};
            financialData.daily.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    const project = row.Proyecto || 'Sin proyecto';
                    const amount = row.Monto || 0;
                    projects[project] = (projects[project] || 0) + amount;
                }
            });

            const labels = Object.keys(projects);
            const data = Object.values(projects);

            if (charts.projectChart) charts.projectChart.destroy();

            charts.projectChart = new Chart(ctx, {
                type: 'pie', data: { labels, datasets: [{
                    data, backgroundColor: ['#2e7d32', '#558b2f', '#7cb342', '#aed581', '#c5e1a5']
                }]}, options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactions-body');
            const typeFilter = document.getElementById('type-filter').value;
            const monthFilter = document.getElementById('month-filter').value;
            
            let filteredData = financialData.daily;
            if (typeFilter !== 'all') filteredData = filteredData.filter(row => row['Tipo (Ingreso/Egreso)'] === typeFilter);
            if (monthFilter !== 'all') filteredData = filteredData.filter(row => row.Mes == monthFilter);
            
            const recentTransactions = filteredData.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha)).slice(0, 10);

            tbody.innerHTML = '';
            recentTransactions.forEach(row => {
                const type = row['Tipo (Ingreso/Egreso)'];
                const amount = row.Monto || 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDate(row.Fecha)}</td>
                    <td><span class="badge ${type === 'Ingreso' ? 'bg-success' : 'bg-danger'}">${type}</span></td>
                    <td>${row.Categor铆a || 'N/A'}</td>
                    <td class="${type === 'Ingreso' ? 'positive' : 'negative'}">${formatCurrency(amount)}</td>
                    <td>${row.Proyecto || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateProjectFilter() {
            const projectFilter = document.getElementById('project-filter');
            const projects = new Set();
            financialData.daily.forEach(row => { if (row.Proyecto) projects.add(row.Proyecto); });
            financialData.sales.forEach(row => { if (row.Proyecto) projects.add(row.Proyecto); });
            
            while (projectFilter.children.length > 1) projectFilter.removeChild(projectFilter.lastChild);
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project; option.textContent = project;
                projectFilter.appendChild(option);
            });
        }

        function refreshDashboard() {
            showLoading(true);
            loadAllData().then(() => {
                updateDashboard();
                showLoading(false);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency', currency: 'ARS', minimumFractionDigits: 2, maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            try { return new Date(dateString).toLocaleDateString('es-AR'); } catch (e) { return dateString; }
        }

        function showLoading(show) {
            document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type) {
            // Implementaci贸n b谩sica de notificaci贸n
            console.log(`${type}: ${message}`);
        }
    </script>
</body>
</html>
