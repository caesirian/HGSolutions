<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero - HG Soluciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2e7d32;
            --secondary: #558b2f;
            --accent: #7cb342;
            --light: #f1f8e9;
            --dark: #1b5e20;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding-top: 20px;
            min-height: 100vh;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            padding: 24px;
            transition: all 0.3s ease;
            border-left: 6px solid var(--primary);
            backdrop-filter: blur(10px);
        }
        
        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .card-title {
            color: var(--dark);
            font-weight: 700;
            margin-bottom: 20px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 0.95rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .filter-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        
        .positive {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        
        .negative {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
        }
        
        .kpi-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
            margin-top: 8px;
        }
        
        .trend-indicator {
            font-size: 1.2rem;
            margin-left: 5px;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(46, 125, 50, 0.05);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        
        .export-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 280px;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .dashboard-card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Mejoras visuales espec√≠ficas */
        .financial-metrics {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .financial-metrics .stat-number,
        .financial-metrics .stat-label {
            color: white;
        }
        
        .sales-metrics {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .sales-metrics .stat-number,
        .sales-metrics .stat-label {
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header Mejorado -->
        <div class="navbar-custom text-white p-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-2"><i class="fas fa-seedling me-2"></i>Reporte Administrativo/Financiero - HG Soluciones</h3>
                    <p class="mb-0 opacity-75">An√°lisis financiero y de ventas en tiempo real</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <span id="last-update" class="kpi-badge me-2">
                        <i class="fas fa-sync-alt me-1"></i>
                        <span id="update-text">Actualizando...</span>
                    </span>
                    <button class="btn btn-light btn-sm" id="export-btn">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros Mejorados -->
        <div class="filter-section">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">üìÖ Periodo</label>
                    <select id="month-filter" class="form-select">
                        <option value="all">Todos los meses</option>
                        <option value="7">Julio 2025</option>
                        <option value="8">Agosto 2025</option>
                        <option value="9">Septiembre 2025</option>
                        <option value="10">Octubre 2025</option>
                        <option value="11">Noviembre 2025</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">üè¢ Proyecto</label>
                    <select id="project-filter" class="form-select">
                        <option value="all">Todos los proyectos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">üìä Tipo</label>
                    <select id="type-filter" class="form-select">
                        <option value="all">Todos los tipos</option>
                        <option value="Ingreso">Ingresos</option>
                        <option value="Egreso">Egresos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" id="apply-filters">
                        <i class="fas fa-filter me-2"></i>Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- KPIs Mejorados -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card financial-metrics">
                    <div class="card-title"><i class="fas fa-balance-scale"></i> Balance Total</div>
                    <div class="stat-number" id="total-balance">$0</div>
                    <div class="stat-label">Acumulado General</div>
                    <div class="stat-change positive mt-2" id="balance-trend">
                        <i class="fas fa-arrow-up trend-indicator"></i>
                        <span id="balance-change">0%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card financial-metrics">
                    <div class="card-title"><i class="fas fa-arrow-up"></i> Ingresos Totales</div>
                    <div class="stat-number" id="total-income">$0</div>
                    <div class="stat-label">Periodo actual</div>
                    <div class="progress">
                        <div class="progress-bar bg-success" id="income-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card financial-metrics">
                    <div class="card-title"><i class="fas fa-arrow-down"></i> Egresos Totales</div>
                    <div class="stat-number" id="total-expenses">$0</div>
                    <div class="stat-label">Periodo actual</div>
                    <div class="progress">
                        <div class="progress-bar bg-danger" id="expense-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="dashboard-card sales-metrics">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Ventas Totales</div>
                    <div class="stat-number" id="total-sales">$0</div>
                    <div class="stat-label">Registro diario</div>
                    <div class="stat-change positive mt-2" id="sales-trend">
                        <i class="fas fa-arrow-up trend-indicator"></i>
                        <span id="sales-change">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nuevos KPIs Adicionales -->
        <div class="row g-3 mb-4">
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-receipt"></i> Transacciones</div>
                    <div class="stat-number" id="total-transactions">0</div>
                    <div class="stat-label">Total registros</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-percentage"></i> Margen Neto</div>
                    <div class="stat-number" id="net-margin">0%</div>
                    <div class="stat-label">Rentabilidad</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-users"></i> Clientes Activos</div>
                    <div class="stat-number" id="active-clients">0</div>
                    <div class="stat-label">Total clientes</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-box"></i> Productos Vendidos</div>
                    <div class="stat-number" id="products-sold">0</div>
                    <div class="stat-label">Unidades totales</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-truck"></i> Proveedores</div>
                    <div class="stat-number" id="total-suppliers">0</div>
                    <div class="stat-label">Activos</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="dashboard-card">
                    <div class="card-title"><i class="fas fa-cube"></i> Ticket Promedio</div>
                    <div class="stat-number" id="average-ticket">$0</div>
                    <div class="stat-label">Por venta</div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos Mejorados -->
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> Balance Mensual</div>
                    <div class="chart-container">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-chart-pie"></i> Ingresos vs Egresos</div>
                    <div class="chart-container">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-tags"></i> Ventas por Categor√≠a</div>
                    <div class="chart-container">
                        <canvas id="salesCategoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-project-diagram"></i> Transacciones por Proyecto</div>
                    <div class="chart-container">
                        <canvas id="projectChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nuevos Gr√°ficos Avanzados -->
        <div class="row g-3 mt-2">
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-calendar-alt"></i> Tendencias Mensuales</div>
                    <div class="chart-container">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="dashboard-card fade-in">
                    <div class="card-title"><i class="fas fa-user-tie"></i> Top 5 Clientes</div>
                    <div class="chart-container">
                        <canvas id="topClientsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de transacciones mejorada -->
        <div class="dashboard-card mt-4 fade-in">
            <div class="card-title d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list-alt"></i> Transacciones Recientes</span>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" id="toggle-view">
                        <i class="fas fa-exchange-alt"></i> Alternar Vista
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="transactions-table">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Categor√≠a</th>
                            <th>Monto</th>
                            <th>Proyecto</th>
                            <th>Responsable</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-body">
                        <!-- Datos cargados din√°micamente -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-end">
                <small class="text-muted" id="table-summary">Mostrando 0 transacciones</small>
            </div>
        </div>

        <!-- Resumen Ejecutivo -->
        <div class="dashboard-card mt-4 fade-in">
            <div class="card-title"><i class="fas fa-chart-line"></i> Resumen Ejecutivo</div>
            <div class="row g-3" id="executive-summary">
                <!-- Resumen generado din√°micamente -->
            </div>
        </div>

        <div class="loading" id="loading-indicator">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando datos...</span>
            </div>
            <p class="mt-3">Cargando datos financieros en tiempo real...</p>
        </div>
    </div>

    <script>
        // Configuraci√≥n mejorada
        const SHEET_ID = '15OBpWVzSX-jXXX99k1T9iZZtIoIj-appiH45w3BSBDY';
        const FINANZAS_MENSUAL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Finanzas_Mensual`;
        const FINANZAS_REGISTRO_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Finanzas_RegistroDiario`;
        const VENTAS_REGISTRO_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Ventas_RegistroDiario`;

        // Variables globales mejoradas
        let financialData = {
            monthly: [],
            daily: [],
            sales: [],
            previousData: {}
        };

        let charts = {};
        let currentView = 'table'; // 'table' o 'cards'

        // Inicializaci√≥n mejorada
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            showLoading(true);
            await loadAllData();
            setupEventListeners();
            showLoading(false);
        }

        // Configurar event listeners mejorados
        function setupEventListeners() {
            document.getElementById('refresh-btn').addEventListener('click', refreshDashboard);
            document.getElementById('apply-filters').addEventListener('click', updateDashboard);
            document.getElementById('toggle-view').addEventListener('click', toggleTableView);
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            // Debounce para mejor performance
            let filterTimeout;
            ['month-filter', 'project-filter', 'type-filter'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(updateDashboard, 300);
                });
            });
        }

        // Funci√≥n para refrescar todo el dashboard
        async function refreshDashboard() {
            showLoading(true);
            await loadAllData();
            updateDashboard();
            showNotification('Datos actualizados correctamente', 'success');
        }

        // Cargar todos los datos mejorado
        async function loadAllData() {
            try {
                await Promise.all([
                    loadFinancialMonthlyData(),
                    loadFinancialDailyData(),
                    loadSalesData()
                ]);
                
                // Guardar datos anteriores para calcular tendencias
                financialData.previousData = {
                    income: financialData.monthly.reduce((sum, row) => sum + (row['Total Ingresos'] || 0), 0),
                    sales: financialData.sales.reduce((sum, row) => sum + (row.Total || 0), 0)
                };
                
                document.getElementById('update-text').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error cargando datos:', error);
                showNotification('Error al cargar los datos', 'error');
            }
        }

        // ... (las funciones de parseo y carga de datos se mantienen iguales)

        // Actualizar todo el dashboard mejorado
        function updateDashboard() {
            updateQuickStats();
            updateAdvancedKPIs();
            updateCharts();
            updateTransactionsTable();
            updateProjectFilter();
            updateExecutiveSummary();
        }

        // Actualizar KPIs avanzados
        function updateAdvancedKPIs() {
            const monthFilter = document.getElementById('month-filter').value;
            
            // Calcular m√©tricas avanzadas
            let totalTransactions = 0;
            let activeClients = new Set();
            let productsSold = 0;
            let totalSuppliers = new Set();
            let totalSalesAmount = 0;
            let transactionCount = 0;

            // Datos de ventas
            financialData.sales.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    totalTransactions++;
                    activeClients.add(row.Cliente);
                    productsSold += row.Cantidad || 0;
                    totalSalesAmount += row.Total || 0;
                }
            });

            // Datos financieros
            financialData.daily.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    transactionCount++;
                    if (row['Cliente/Proveedor']) {
                        totalSuppliers.add(row['Cliente/Proveedor']);
                    }
                }
            });

            // Calcular m√©tricas derivadas
            const netIncome = financialData.monthly.reduce((sum, row) => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    return sum + (row['Total Ingresos'] || 0) - (row['Total Egresos'] || 0);
                }
                return sum;
            }, 0);

            const totalIncome = financialData.monthly.reduce((sum, row) => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    return sum + (row['Total Ingresos'] || 0);
                }
                return sum;
            }, 0);

            const netMargin = totalIncome > 0 ? (netIncome / totalIncome * 100) : 0;
            const averageTicket = totalTransactions > 0 ? totalSalesAmount / totalTransactions : 0;

            // Actualizar UI
            document.getElementById('total-transactions').textContent = transactionCount.toLocaleString();
            document.getElementById('net-margin').textContent = `${netMargin.toFixed(1)}%`;
            document.getElementById('active-clients').textContent = activeClients.size;
            document.getElementById('products-sold').textContent = productsSold.toLocaleString();
            document.getElementById('total-suppliers').textContent = totalSuppliers.size;
            document.getElementById('average-ticket').textContent = formatCurrency(averageTicket);

            // Actualizar tendencias
            updateTrendIndicators();
        }

        // Actualizar indicadores de tendencia
        function updateTrendIndicators() {
            const currentIncome = financialData.monthly.reduce((sum, row) => sum + (row['Total Ingresos'] || 0), 0);
            const currentSales = financialData.sales.reduce((sum, row) => sum + (row.Total || 0), 0);
            
            const incomeChange = financialData.previousData.income > 0 ? 
                ((currentIncome - financialData.previousData.income) / financialData.previousData.income * 100) : 0;
            
            const salesChange = financialData.previousData.sales > 0 ? 
                ((currentSales - financialData.previousData.sales) / financialData.previousData.sales * 100) : 0;

            // Actualizar indicadores
            document.getElementById('balance-change').textContent = `${Math.abs(incomeChange).toFixed(1)}%`;
            document.getElementById('sales-change').textContent = `${Math.abs(salesChange).toFixed(1)}%`;

            // Actualizar progres bars
            const total = currentIncome + financialData.monthly.reduce((sum, row) => sum + (row['Total Egresos'] || 0), 0);
            const incomePercent = total > 0 ? (currentIncome / total * 100) : 0;
            const expensePercent = total > 0 ? (100 - incomePercent) : 0;

            document.getElementById('income-progress').style.width = `${incomePercent}%`;
            document.getElementById('expense-progress').style.width = `${expensePercent}%`;
        }

        // Nuevos gr√°ficos avanzados
        function updateMonthlyTrendsChart() {
            const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
            const months = financialData.monthly.map(row => `Mes ${row.Mes}`);
            const incomes = financialData.monthly.map(row => row['Total Ingresos'] || 0);
            const expenses = financialData.monthly.map(row => row['Total Egresos'] || 0);
            const balances = financialData.monthly.map(row => row.Balance || 0);

            if (charts.monthlyTrendsChart) {
                charts.monthlyTrendsChart.destroy();
            }

            charts.monthlyTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: incomes,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Egresos',
                            data: expenses,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Balance',
                            data: balances,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function updateTopClientsChart() {
            const ctx = document.getElementById('topClientsChart').getContext('2d');
            const monthFilter = document.getElementById('month-filter').value;
            
            // Agrupar ventas por cliente
            const clients = {};
            financialData.sales.forEach(row => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    const client = row.Cliente || 'Cliente no identificado';
                    const total = row.Total || 0;
                    clients[client] = (clients[client] || 0) + total;
                }
            });

            // Ordenar y tomar top 5
            const topClients = Object.entries(clients)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const labels = topClients.map(([client]) => client);
            const data = topClients.map(([,total]) => total);

            if (charts.topClientsChart) {
                charts.topClientsChart.destroy();
            }

            charts.topClientsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas por Cliente',
                        data: data,
                        backgroundColor: [
                            '#2e7d32', '#558b2f', '#7cb342', '#aed581', '#c5e1a5'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Actualizar resumen ejecutivo
        function updateExecutiveSummary() {
            const monthFilter = document.getElementById('month-filter').value;
            const summaryElement = document.getElementById('executive-summary');
            
            const totalIncome = financialData.monthly.reduce((sum, row) => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    return sum + (row['Total Ingresos'] || 0);
                }
                return sum;
            }, 0);

            const totalExpenses = financialData.monthly.reduce((sum, row) => {
                if (monthFilter === 'all' || row.Mes == monthFilter) {
                    return sum + (row['Total Egresos'] || 0);
                }
                return sum;
            }, 0);

            const netProfit = totalIncome - totalExpenses;
            const profitMargin = totalIncome > 0 ? (netProfit / totalIncome * 100) : 0;

            summaryElement.innerHTML = `
                <div class="col-md-4">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-trophy me-2"></i>Resultado del Periodo</h6>
                        <p class="mb-1">Utilidad Neta: <strong>${formatCurrency(netProfit)}</strong></p>
                        <p class="mb-0">Margen de Ganancia: <strong>${profitMargin.toFixed(1)}%</strong></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-chart-line me-2"></i>Eficiencia Operativa</h6>
                        <p class="mb-1">Relaci√≥n Ingresos/Egresos: <strong>${totalExpenses > 0 ? (totalIncome/totalExpenses).toFixed(2) : 'N/A'}</strong></p>
                        <p class="mb-0">Ticket Promedio: <strong>${formatCurrency(document.getElementById('average-ticket').textContent)}</strong></p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Recomendaciones</h6>
                        <p class="mb-1">Clientes Activos: <strong>${document.getElementById('active-clients').textContent}</strong></p>
                        <p class="mb-0">Transacciones: <strong>${document.getElementById('total-transactions').textContent}</strong></p>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para alternar entre vista de tabla y tarjetas
        function toggleTableView() {
            const tableBody = document.getElementById('transactions-body');
            const toggleBtn = document.getElementById('toggle-view');
            
            if (currentView === 'table') {
                // Cambiar a vista de tarjetas
                currentView = 'cards';
                toggleBtn.innerHTML = '<i class="fas fa-table"></i> Vista Tabla';
                // Implementar l√≥gica para mostrar tarjetas
            } else {
                // Cambiar a vista de tabla
                currentView = 'table';
                toggleBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Alternar Vista';
                // Implementar l√≥gica para mostrar tabla
            }
            updateTransactionsTable();
        }

        // Funci√≥n para exportar datos
        function exportData() {
            const dataStr = JSON.stringify(financialData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Datos exportados correctamente', 'success');
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type) {
            // Implementar sistema de notificaciones toast
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        // ... (las dem√°s funciones se mantienen iguales pero mejoradas)

        // Utilidades mejoradas
        function formatCurrency(amount) {
            if (typeof amount === 'string') {
                amount = parseArgentineNumber(amount);
            }
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showLoading(show) {
            document.getElementById('loading-indicator').style.display = 
                show ? 'block' : 'none';
        }

        // Incluir aqu√≠ todas las funciones de parseo y carga que ya ten√≠amos...
        // [Todas las funciones anteriores de parseArgentineNumber, loadFinancialMonthlyData, etc.]

    </script>
</body>
</html>
